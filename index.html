<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tellurian Ritual Engine — Lullaby Re-Binding</title>
  <link rel="stylesheet" href="./styles.css?v=2" />
</head>
<body>
  <div id="app" class="app">

    <!-- TOP BAR -->
    <header class="topbar">
      <div class="brand">
        <div class="brand__title">The Lullaby of the Rootbound Heart</div>
        <div class="brand__subtitle">Tellurian Re-Binding Ritual Engine</div>
      </div>

      <div class="topControls">
        <button class="btn btn--ghost" id="btnSound">Enable Sound</button>
        <button class="btn btn--ghost" id="btnDock">DM Dock</button>
        <button class="btn" id="btnRollEvent">Roll Event</button>
        <button class="btn btn--primary" id="btnNextRound">Next Round</button>
      </div>
    </header>

    <!-- HUD STRIP -->
    <section class="hudStrip">
      <div class="hudBlock">
        <div class="hudLabel">Ritual Round</div>
        <div class="hudValue"><span id="roundNow">1</span>/<span id="roundMax">8</span></div>
        <div class="pips" id="roundPips" aria-hidden="true"></div>
      </div>

      <div class="hudBlock hudBlock--wide">
        <div class="hudLabel">Heartwood Event</div>
        <div class="hudValue hudValue--event" id="eventTitle">Root Stirring</div>
        <div class="hudHint" id="eventHint">Click “Roll Event”, then “Apply Event”.</div>
        <div class="hudMiniRow">
          <button class="btn btn--small" id="btnApplyEvent">Apply Event</button>
          <button class="btn btn--small btn--ghost" id="btnPrevEvent">◀</button>
          <button class="btn btn--small btn--ghost" id="btnNextEvent">▶</button>
        </div>
      </div>

      <div class="hudBlock">
        <div class="hudLabel">Pulse</div>
        <div class="hudValue" id="pulseLabel">Steady</div>
        <div class="hudHint" id="stateLabel">Binding in progress</div>
      </div>
    </section>

    <!-- MAIN STAGE -->
    <main class="stage">

      <!-- LEFT: HEARTWOOD -->
      <section class="panel corePanel" aria-label="Heartwood Core">
        <div class="panelHead">
          <div>
            <div class="panelTitle">Heartwood</div>
            <div class="panelSub">Visual pulse responds to Stress and locks</div>
          </div>
        </div>

        <div class="core">
          <div class="core__frame">
            <!-- Heartwood image is rendered via CSS ::before -->
            <svg class="heartwoodFX" viewBox="0 0 600 600" aria-hidden="true">
              <defs>
                <filter id="softGlow" x="-60%" y="-60%" width="220%" height="220%">
                  <feGaussianBlur stdDeviation="7" result="b"/>
                  <feMerge>
                    <feMergeNode in="b"/>
                    <feMergeNode in="SourceGraphic"/>
                  </feMerge>
                </filter>
              </defs>

              <!-- Glow rings + root strokes only (NO filled trunk) -->
              <g filter="url(#softGlow)" opacity="0.95">
                <circle class="fxRing" cx="300" cy="300" r="220"/>
                <circle class="fxRing fxRing2" cx="300" cy="300" r="170"/>
                <circle class="fxRing fxRing3" cx="300" cy="300" r="120"/>
                <circle class="fxDot" cx="300" cy="300" r="14"/>

                <path class="fxRoot" d="M300 95 C 245 135, 215 170, 190 225 C 160 295, 175 345, 220 380"/>
                <path class="fxRoot" d="M300 95 C 355 135, 385 170, 410 225 C 440 295, 425 345, 380 380"/>
                <path class="fxRoot" d="M120 315 C 170 260, 215 225, 280 205 C 340 187, 395 202, 450 240"/>
                <path class="fxRoot" d="M480 300 C 430 350, 388 392, 330 412 C 270 432, 210 420, 170 388"/>
              </g>
            </svg>

            <div class="coreReadout">
              <div class="readRow"><span class="tag">Tip</span> <span class="val">Use “Next Round” + stone Attempts. Keep it tabletop: you enter rolls.</span></div>
              <div class="readRow"><span class="tag">Shortcuts</span> <span class="val"><kbd>`</kbd> DM Dock • <kbd>N</kbd> Next • <kbd>E</kbd> Roll Event</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CENTER: STONES -->
      <section class="panel stonesPanel" aria-label="Glyph Stones">
        <div class="panelHead">
          <div>
            <div class="panelTitle">Glyph Stones</div>
            <div class="panelSub">Attempt = enter roll • Assist = small adjustment / advantage</div>
          </div>
        </div>

        <div class="stones">

          <!-- WEIGHT -->
          <article class="stone" data-stone="weight">
            <header class="stoneHead">
              <div>
                <div class="stoneName">Stone of Weight</div>
                <div class="stoneSub">Stabilisation</div>
              </div>
              <div class="stoneMeters">
                <div class="miniLabel">Progress</div>
                <div class="pips" id="prog_weight"></div>
              </div>
            </header>

            <div class="stoneBody">
              <div class="stoneDisk" id="disk_weight" aria-hidden="true">
                <div class="cracks" id="crack_weight"></div>
              </div>

              <div class="stoneInfo">
                <div class="line"><span class="miniLabel">Stress</span><span class="stressRow" id="stress_weight"></span></div>
                <div class="rule" id="rule_weight"></div>

                <div class="stoneActions">
                  <button class="btn" data-action="attempt" data-stone="weight">Attempt</button>
                  <button class="btn btn--ghost" data-action="assist" data-stone="weight">Assist</button>
                </div>
              </div>
            </div>
          </article>

          <!-- MEMORY -->
          <article class="stone" data-stone="memory">
            <header class="stoneHead">
              <div>
                <div class="stoneName">Stone of Memory</div>
                <div class="stoneSub">Resonance</div>
              </div>
              <div class="stoneMeters">
                <div class="miniLabel">Progress</div>
                <div class="pips" id="prog_memory"></div>
              </div>
            </header>

            <div class="stoneBody">
              <div class="stoneDisk" id="disk_memory" aria-hidden="true">
                <div class="cracks" id="crack_memory"></div>
              </div>

              <div class="stoneInfo">
                <div class="line">
                  <span class="miniLabel">Stress</span><span class="stressRow" id="stress_memory"></span>
                  <span class="chip">Target: <span id="memoryTarget">6</span></span>
                </div>
                <div class="rule" id="rule_memory"></div>

                <div class="stoneActions">
                  <button class="btn" data-action="attempt" data-stone="memory">Attempt</button>
                  <button class="btn btn--ghost" data-action="assist" data-stone="memory">Assist</button>
                </div>
              </div>
            </div>
          </article>

          <!-- SILENCE -->
          <article class="stone" data-stone="silence">
            <header class="stoneHead">
              <div>
                <div class="stoneName">Stone of Silence</div>
                <div class="stoneSub">Containment</div>
              </div>
              <div class="stoneMeters">
                <div class="miniLabel">Progress</div>
                <div class="pips" id="prog_silence"></div>
              </div>
            </header>

            <div class="stoneBody">
              <div class="stoneDisk" id="disk_silence" aria-hidden="true">
                <div class="cracks" id="crack_silence"></div>
              </div>

              <div class="stoneInfo">
                <div class="line"><span class="miniLabel">Stress</span><span class="stressRow" id="stress_silence"></span></div>
                <div class="rule" id="rule_silence"></div>

                <div class="stoneActions">
                  <button class="btn" data-action="attempt" data-stone="silence">Attempt</button>
                  <button class="btn btn--ghost" data-action="assist" data-stone="silence">Assist</button>
                </div>
              </div>
            </div>
          </article>

        </div>
      </section>

      <!-- RIGHT: LOG / INSTRUCTIONS -->
      <section class="panel logPanel" aria-label="Ritual Log">
        <div class="panelHead">
          <div>
            <div class="panelTitle">DM / Table Log</div>
            <div class="panelSub">This is what players should “feel” happening</div>
          </div>
          <button class="btn btn--small btn--ghost" id="btnClearLog">Clear</button>
        </div>

        <div class="log" id="log"></div>

        <div class="miniHelp">
          <div class="miniHelpTitle">How to run it</div>
          <ol>
            <li>Click <b>Roll Event</b> then <b>Apply Event</b> each round.</li>
            <li>Players choose a stone, click <b>Attempt</b>, then you type their result.</li>
            <li>Progress 3 locks a stone. Stress 4 fractures it (fail state).</li>
            <li>Press <b>DM Dock</b> (or <kbd>`</kbd>) for manual overrides.</li>
          </ol>
        </div>
      </section>

    </main>

    <!-- MODAL -->
    <div id="modal" class="modal" aria-hidden="true" role="dialog">
      <div class="modalPanel">
        <div class="modalTitle" id="modalTitle">Attempt</div>
        <div class="modalBody" id="modalBody"></div>

        <div class="modalGrid">
          <label class="field">
            <span class="fieldLabel">Roll Result</span>
            <input id="rollInput" class="input" type="number" inputmode="numeric" placeholder="Enter result" />
          </label>

          <label class="field" id="slotField" style="display:none;">
            <span class="fieldLabel">Slot Level</span>
            <input id="slotInput" class="input" type="number" inputmode="numeric" min="0" max="9" value="0" />
          </label>

          <label class="field" id="advField" style="display:none;">
            <span class="fieldLabel">Advantage?</span>
            <select id="advSelect" class="input">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </label>

          <label class="field" id="memoryAdjustField" style="display:none;">
            <span class="fieldLabel">Target Adjust (Assist)</span>
            <select id="memoryAdjust" class="input">
              <option value="0">0</option>
              <option value="-1">-1</option>
              <option value="1">+1</option>
            </select>
          </label>
        </div>

        <div class="modalActions">
          <button class="btn btn--ghost" id="btnCancel">Cancel</button>
          <button class="btn btn--primary" id="btnApply">Apply</button>
        </div>

        <div class="modalFoot" id="modalFoot"></div>
      </div>
    </div>

    <!-- DM DOCK -->
    <aside id="dmDock" class="dmDock" aria-hidden="true">
      <div class="dmDockHead">
        <div>
          <div class="dmDockTitle">DM Dock</div>
          <div class="dmDockSub">Overrides + quick control. (<kbd>`</kbd> to toggle)</div>
        </div>
        <button class="btn btn--small btn--ghost" id="btnDockClose">Close</button>
      </div>

      <div class="dmGrid">
        <div class="dmCard">
          <div class="dmCardTitle">Round</div>
          <div class="dmRow">
            <button class="btn btn--small btn--ghost" id="btnPrevRound">◀</button>
            <button class="btn btn--small" id="btnNextRoundDock">Next Round</button>
            <button class="btn btn--small btn--ghost" id="btnRollEventDock">Roll Event</button>
          </div>
        </div>

        <div class="dmCard">
          <div class="dmCardTitle">Stress</div>
          <div class="dmRow">
            <select id="stressStone" class="input input--small">
              <option value="weight">Weight</option>
              <option value="memory">Memory</option>
              <option value="silence">Silence</option>
            </select>
            <button class="btn btn--small" id="btnStressPlus">+ Stress</button>
            <button class="btn btn--small btn--ghost" id="btnStressMinus">- Stress</button>
          </div>
        </div>

        <div class="dmCard">
          <div class="dmCardTitle">Progress</div>
          <div class="dmRow">
            <select id="progStone" class="input input--small">
              <option value="weight">Weight</option>
              <option value="memory">Memory</option>
              <option value="silence">Silence</option>
            </select>
            <button class="btn btn--small" id="btnProgPlus">+ Progress</button>
            <button class="btn btn--small btn--ghost" id="btnProgMinus">- Progress</button>
          </div>
        </div>

        <div class="dmCard dmCard--wide">
          <div class="dmCardTitle">Utilities</div>
          <div class="dmRow">
            <button class="btn btn--small btn--ghost" id="btnReset">Reset Ritual</button>
          </div>
          <div class="dmNote">Audio plays only after “Enable Sound”.</div>
        </div>
      </div>
    </aside>

    <div id="toast" class="toast" aria-live="polite"></div>

  </div>

  <script src="./ritual.js?v=2"></script>
</body>
</html>
